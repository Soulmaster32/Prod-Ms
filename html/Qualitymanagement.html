<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QM Dashboard T202603 - Enterprise Pro</title>
    
    <!-- Fonts: Inter for UI, Oswald for Headers -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        header: ['Oswald', 'sans-serif'],
                    },
                    colors: {
                        slate: { 850: '#1e293b', 900: '#0f172a', 950: '#020617' },
                        gold: { 400: '#facc15', 500: '#eab308', 600: '#ca8a04' },
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(0, 0, 0, 0.3)',
                        'neon': '0 0 10px rgba(250, 204, 21, 0.3)',
                    }
                }
            }
        }
    </script>

    <style>
@keyframes float-gentle {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}
.animate-bounce-slow {
    animation: float-gentle 3s ease-in-out infinite;
}



        /* --- CORE STYLES --- */
        body {
            background-color: #0f172a; /* Fallback */
            background-image: radial-gradient(circle at 10% 20%, #1e293b 0%, #020617 90%);
            color: #f1f5f9;
            overflow: hidden; /* Prevent body scroll, handle inside containers */
        }

        /* Glassmorphism Panel */
        .glass-panel {
            background: rgba(30, 41, 59, 0.65);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #eab308; }

        /* Sidebar Animation */
        #sidebar { transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1), transform 0.3s ease; }
        
        /* Sidebar Collapsed State (Desktop) */
        #sidebar.collapsed { width: 70px; }
        #sidebar.collapsed .sidebar-text, 
        #sidebar.collapsed .menu-category, 
        #sidebar.collapsed .badge-pill { display: none; opacity: 0; }
        #sidebar.collapsed .nav-item { justify-content: center; padding-left: 0; padding-right: 0; }
        #sidebar.collapsed .nav-icon { margin-right: 0; font-size: 1.2rem; }
        
        /* Tooltip Logic for Collapsed Sidebar */
        #sidebar.collapsed .nav-item:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            margin-left: 10px;
            background: #eab308;
            color: #020617;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            white-space: nowrap;
            z-index: 50;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        /* Table Styles */
        .glass-table th { background: rgba(15, 23, 42, 0.8); color: #facc15; font-family: 'Oswald'; letter-spacing: 0.05em; text-transform: uppercase; font-size: 0.75rem; }
        .glass-table td { border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.85rem; }
        .glass-table tr:hover td { background: rgba(255,255,255,0.05); }

        /* Drag & Drop Visuals */
        .scrum-card { cursor: grab; transition: transform 0.2s, box-shadow 0.2s; }
        .scrum-card:active { cursor: grabbing; transform: scale(1.02); }
        .scrum-card.dragging { opacity: 0.4; border: 1px dashed #facc15; }
        .scrum-col.drag-over { background: rgba(255,255,255,0.1); border: 2px dashed #facc15; }

        /* Mobile Adjustments */
        @media (max-width: 1024px) {
            #sidebar { position: fixed; height: 100%; z-index: 50; transform: translateX(-100%); width: 260px; }
            #sidebar.mobile-open { transform: translateX(0); }
            .desktop-search { display: none; }
        }
    </style>
</head>
<body class="antialiased font-sans text-slate-200">

<!-- Mobile Backdrop -->
<div id="mobileBackdrop" onclick="App.toggleSidebar()" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-40 hidden transition-opacity"></div>

<div class="flex h-screen w-full">

    <!-- SIDEBAR -->
    <aside id="sidebar" class="glass-panel h-full flex flex-col flex-shrink-0 z-50">
        <!-- Brand -->
        <div class="h-16 flex items-center justify-center border-b border-white/10 relative">
            <div class="flex items-center gap-3 sidebar-text transition-opacity duration-200">
                <i class="fas fa-shield-alt text-gold-400 text-2xl drop-shadow-lg"></i>
                <h2 class="font-header text-xl tracking-wider font-bold text-white">Quality<span class="text-gold-400">Group</span></h2>
            </div>
            <!-- Icon only when collapsed -->
            <i class="fas fa-shield-alt text-gold-400 text-2xl absolute left-1/2 -translate-x-1/2 opacity-0 transition-opacity duration-200" id="brandIconCollapsed"></i>
        </div>

        <!-- User Profile -->
        <div class="p-6 text-center border-b border-white/10 sidebar-text">
            <div class="w-16 h-16 rounded-full bg-gradient-to-br from-slate-700 to-slate-900 border-2 border-gold-500 mx-auto flex items-center justify-center shadow-neon mb-3">
                <span class="font-header text-xl text-gold-400">AD</span>
            </div>
            <h4 class="font-bold text-white text-sm">Admin User</h4>
            <span class="text-xs text-slate-400 uppercase tracking-wider">Quality Lead</span>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 overflow-y-auto custom-scroll py-4 px-2 space-y-1">
            <a href="#dashboard" class="nav-item relative flex items-center px-4 py-3 text-slate-300 hover:bg-white/10 hover:text-white rounded-lg transition-all group" data-tooltip="Dashboard">
                <i class="fas fa-chart-line nav-icon w-5 text-center text-slate-400 group-hover:text-gold-400 transition-colors mr-3"></i>
                <span class="sidebar-text font-medium text-sm">Dashboard</span>
            </a>

            <div class="menu-category mt-6 mb-2 px-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest">Quality Modules</div>

            <a href="#section-product" class="nav-item relative flex items-center px-4 py-3 text-slate-300 hover:bg-white/10 hover:text-white rounded-lg transition-all group" data-tooltip="Product Quality">
                <i class="fas fa-boxes nav-icon w-5 text-center text-slate-400 group-hover:text-gold-400 transition-colors mr-3"></i>
                <span class="sidebar-text font-medium text-sm">Product Quality</span>
            </a>
            
            <a href="#section-audit" class="nav-item relative flex items-center px-4 py-3 text-slate-300 hover:bg-white/10 hover:text-white rounded-lg transition-all group" data-tooltip="Audit Findings">
                <i class="fas fa-clipboard-check nav-icon w-5 text-center text-slate-400 group-hover:text-gold-400 transition-colors mr-3"></i>
                <span class="sidebar-text font-medium text-sm">Audit Findings</span>
                <span class="badge-pill ml-auto bg-red-500/80 text-white text-[10px] font-bold px-2 py-0.5 rounded-full">3</span>
            </a>

            <a href="#section-scrum" class="nav-item relative flex items-center px-4 py-3 text-slate-300 hover:bg-white/10 hover:text-white rounded-lg transition-all group" data-tooltip="Scrum Board">
                <i class="fas fa-th-large nav-icon w-5 text-center text-slate-400 group-hover:text-gold-400 transition-colors mr-3"></i>
                <span class="sidebar-text font-medium text-sm">Scrum Board</span>
            </a>

            <a href="#section-claims" class="nav-item relative flex items-center px-4 py-3 text-slate-300 hover:bg-white/10 hover:text-white rounded-lg transition-all group" data-tooltip="Claims">
                <i class="fas fa-exclamation-triangle nav-icon w-5 text-center text-slate-400 group-hover:text-gold-400 transition-colors mr-3"></i>
                <span class="sidebar-text font-medium text-sm">Claims Report</span>
            </a>
        </nav>
        
        <!-- Footer -->
        <div class="p-4 border-t border-white/10 sidebar-text text-center">
            <p class="text-[10px] text-slate-500">&copy; 2026 QM System v4.1</p>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col h-full overflow-hidden relative bg-slate-900/50">
        
        <!-- Top Header -->
        <header class="h-16 glass-panel border-b border-white/5 flex items-center justify-between px-6 z-30">
            <div class="flex items-center gap-4">
                <button onclick="App.toggleSidebar()" class="text-slate-400 hover:text-gold-400 transition-colors p-2 rounded-lg hover:bg-white/5">
                    <i class="fas fa-bars text-lg"></i>
                </button>
                <h1 class="font-header text-xl text-white tracking-wide hidden sm:block">QUALITY MANAGEMENT DASHBOARD</h1>
            </div>

            <div class="flex items-center gap-3">
                <!-- Search -->
                <div class="relative hidden md:block">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"></i>
                    <input type="text" oninput="App.handleSearch(this.value)" placeholder="Search audits, tasks..." 
                        class="bg-slate-950/50 border border-white/10 rounded-full py-1.5 pl-9 pr-4 text-sm focus:outline-none focus:border-gold-500 w-64 transition-all">
                </div>

                <!-- Actions -->
                <div class="flex gap-2">
                    <button onclick="App.exportData()" title="Export JSON" class="bg-slate-800 hover:bg-slate-700 text-slate-200 p-2 rounded-lg border border-white/10 transition-colors">
                        <i class="fas fa-download"></i>
                    </button>
                    <label title="Import JSON" class="bg-slate-800 hover:bg-slate-700 text-slate-200 p-2 rounded-lg border border-white/10 transition-colors cursor-pointer">
                        <i class="fas fa-upload"></i>
                        <input type="file" id="importFile" hidden onchange="App.importData(event)">
                    </label>
                    <button onclick="App.resetAll()" title="Reset Data" class="bg-red-900/30 hover:bg-red-900/50 text-red-400 p-2 rounded-lg border border-red-500/30 transition-colors">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto custom-scroll p-4 md:p-6" id="dashboard">
            
            <!-- KPI CARDS ROW -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="glass-panel p-4 rounded-xl flex items-center justify-between border-l-4 border-gold-500">
                    <div>
                        <p class="text-xs text-slate-400 uppercase font-bold">Total Audits</p>
                        <h3 class="text-2xl font-header text-white mt-1">124</h3>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-gold-500/10 flex items-center justify-center text-gold-400"><i class="fas fa-clipboard-list"></i></div>
                </div>
                <div class="glass-panel p-4 rounded-xl flex items-center justify-between border-l-4 border-blue-500">
                    <div>
                        <p class="text-xs text-slate-400 uppercase font-bold">Compliance Rate</p>
                        <h3 class="text-2xl font-header text-white mt-1">98.5%</h3>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-blue-500/10 flex items-center justify-center text-blue-400"><i class="fas fa-check-circle"></i></div>
                </div>
                <div class="glass-panel p-4 rounded-xl flex items-center justify-between border-l-4 border-red-500">
                    <div>
                        <p class="text-xs text-slate-400 uppercase font-bold">Open Claims</p>
                        <h3 class="text-2xl font-header text-white mt-1" id="kpiClaims">0</h3>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-red-500/10 flex items-center justify-center text-red-400"><i class="fas fa-exclamation-triangle"></i></div>
                </div>
                <div class="glass-panel p-4 rounded-xl flex items-center justify-between border-l-4 border-green-500">
                    <div>
                        <p class="text-xs text-slate-400 uppercase font-bold">Scrum Done</p>
                        <h3 class="text-2xl font-header text-white mt-1" id="kpiScrum">0%</h3>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-green-500/10 flex items-center justify-center text-green-400"><i class="fas fa-tasks"></i></div>
                </div>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                
                <!-- PRODUCT QUALITY CHART -->
                <div class="glass-panel rounded-xl p-6 xl:col-span-2 flex flex-col" id="section-product">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-header text-lg text-gold-400 uppercase tracking-wide">Product Quality Trends (2026)</h3>
                        <span class="text-xs bg-white/5 px-2 py-1 rounded border border-white/10">YTD Analysis</span>
                    </div>
                    <div class="flex-1 min-h-[300px] relative w-full">
                        <canvas id="qualityChart"></canvas>
                    </div>
                </div>

                <!-- OBJECTIVES -->
                <div class="glass-panel rounded-xl p-6 xl:col-span-1 flex flex-col justify-center relative overflow-hidden group">
                    <div class="absolute top-0 right-0 -mt-4 -mr-4 text-9xl text-white opacity-5 group-hover:opacity-10 transition-opacity pointer-events-none">
                        <i class="fas fa-bullseye"></i>
                    </div>
                    <h3 class="font-header text-lg text-white mb-6 border-b border-white/10 pb-2">Vission & Mission</h3>
                    
                    <div class="mb-6">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-eye text-gold-400"></i>
                            <span class="text-sm font-bold text-slate-300">VISION</span>
                        </div>
                        <p class="text-sm text-slate-400 leading-relaxed pl-6 border-l-2 border-gold-500/30">
                            Achieve zero internal & external claims through excellence in process and product quality.
                        </p>
                    </div>
                    
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-rocket text-gold-400"></i>
                            <span class="text-sm font-bold text-slate-300">MISSION</span>
                        </div>
                        <p class="text-sm text-slate-400 leading-relaxed pl-6 border-l-2 border-gold-500/30">
                            Sustainability, standardization, continuous equipment monitoring, commitment, and discipline.
                        </p>
                    </div>
                </div>

                <!-- AUDIT FINDINGS TABLE -->
                <div class="glass-panel rounded-xl xl:col-span-3 flex flex-col min-h-[500px]" id="section-audit">
                    <div class="p-4 border-b border-white/10 flex flex-wrap justify-between items-center gap-4">
                        <h3 class="font-header text-lg text-white"><i class="fas fa-search text-gold-400 mr-2"></i>INTERNAL AUDIT FINDINGS</h3>
                        <button onclick="App.openAuditModal('add')" class="bg-gold-500 hover:bg-gold-400 text-slate-900 font-bold py-1.5 px-4 rounded shadow-lg transition-transform hover:-translate-y-0.5 text-sm">
                            <i class="fas fa-plus mr-1"></i> New Finding
                        </button>
                    </div>
                    <div class="flex-1 overflow-x-auto custom-scroll">
                        <table class="w-full text-left border-collapse glass-table min-w-[1000px]">
                            <thead>
                                <tr>
                                    <th class="p-3 text-center w-12">#</th>
                                    <th class="p-3 text-center w-20">Before</th>
                                    <th class="p-3 w-1/4">Issue & Plan</th>
                                    <th class="p-3 text-center w-20">After</th>
                                    <th class="p-3 w-1/4">Corrective Action</th>
                                    <th class="p-3">Status</th>
                                    <th class="p-3">PIC</th>
                                    <th class="p-3">Target</th>
                                    <th class="p-3 text-center w-24">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="auditBody">
                                <!-- JS Rendered -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- SCRUM BOARD -->
                <div class="glass-panel rounded-xl xl:col-span-3 p-6" id="section-scrum">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-header text-lg text-white"><i class="fas fa-th-large text-gold-400 mr-2"></i>KAIZEN SCRUM BOARD</h3>
                        <button onclick="App.openScrumModal('add')" class="text-sm text-gold-400 hover:text-white border border-gold-500/30 hover:bg-gold-500/10 px-3 py-1 rounded transition-colors">
                            <i class="fas fa-plus mr-1"></i> Add Task
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 overflow-x-auto" id="scrumBoard">
                        <!-- JS Rendered -->
                    </div>
                </div>

                <!-- CLAIMS & PROCESS FLOW -->
                <div class="glass-panel rounded-xl xl:col-span-2 p-6" id="section-claims">
                    <h3 class="font-header text-lg text-white mb-4"><i class="fas fa-file-invoice text-gold-400 mr-2"></i>CLAIMS & NEARMISS</h3>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs text-slate-400 uppercase">Recent Reports</span>
                        <button onclick="App.addClaim()" class="text-xs text-gold-400 hover:underline">Add New</button>
                    </div>
                    <ul id="claimsList" class="space-y-2 max-h-64 overflow-y-auto custom-scroll pr-2">
                        <!-- JS Rendered -->
                    </ul>
                </div>
                
                <div class="glass-panel rounded-xl xl:col-span-1 p-6" id="section-improvement">
                     <h3 class="font-header text-lg text-white mb-4"><i class="fas fa-project-diagram text-gold-400 mr-2"></i>IMPROVEMENT FLOW</h3>
                     <div class="space-y-4">
                         <div class="flex items-center gap-3 p-3 bg-slate-800/50 rounded border border-white/5">
                             <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center font-bold text-white">1</div>
                             <div class="text-sm text-slate-300">Bagger Check</div>
                             <i class="fas fa-arrow-right ml-auto text-slate-600"></i>
                         </div>
                         <div class="flex items-center gap-3 p-3 bg-slate-800/50 rounded border border-white/5">
                             <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center font-bold text-white">2</div>
                             <div class="text-sm text-slate-300">Warehouse QA</div>
                             <i class="fas fa-arrow-right ml-auto text-slate-600"></i>
                         </div>
                         <div class="flex items-center gap-3 p-3 bg-slate-800/50 rounded border border-white/5">
                             <div class="w-8 h-8 rounded-full bg-gold-600 flex items-center justify-center font-bold text-white">3</div>
                             <div class="text-sm text-white font-bold">Ship Loading</div>
                             <i class="fas fa-check ml-auto text-gold-400"></i>
                         </div>
                     </div>
                </div>

            </div> <!-- End Grid -->
            
            <div class="mt-8 text-center text-slate-600 text-xs">
                Quality Management System &copy; 2026 | Built for Performance
            </div>
        </div>
    </main>
</div>

<!-- AUDIT MODAL -->
<div id="auditModal" class="fixed inset-0 z-[100] hidden items-center justify-center">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity" onclick="App.closeModal('auditModal')"></div>
    <div class="relative bg-slate-900 border border-gold-500/30 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col transform transition-all">
        <div class="bg-slate-950 p-4 border-b border-white/10 flex justify-between items-center rounded-t-xl">
            <h3 class="font-header text-xl text-gold-400">AUDIT FINDING RECORD</h3>
            <button onclick="App.closeModal('auditModal')" class="text-slate-400 hover:text-white text-2xl">&times;</button>
        </div>
        <div class="p-6 overflow-y-auto custom-scroll">
            <form id="auditForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <input type="hidden" id="auditId">
                <div class="lg:col-span-3">
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Finding Description</label>
                    <textarea id="auditDesc" rows="2" class="w-full bg-slate-800 border border-white/10 rounded p-3 text-sm focus:border-gold-500 focus:outline-none"></textarea>
                </div>
                <div><label class="block text-xs font-bold text-slate-400 uppercase mb-2">Img URL (Before)</label><input type="text" id="auditImgBefore" class="w-full bg-slate-800 border border-white/10 rounded p-2 text-sm"></div>
                <div><label class="block text-xs font-bold text-slate-400 uppercase mb-2">Plan of Action</label><input type="text" id="auditPlan" class="w-full bg-slate-800 border border-white/10 rounded p-2 text-sm"></div>
                <div><label class="block text-xs font-bold text-slate-400 uppercase mb-2">Img URL (After)</label><input type="text" id="auditImgAfter" class="w-full bg-slate-800 border border-white/10 rounded p-2 text-sm"></div>
                <div><label class="block text-xs font-bold text-slate-400 uppercase mb-2">Corrective Action</label><input type="text" id="auditCATaken" class="w-full bg-slate-800 border border-white/10 rounded p-2 text-sm"></div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Status</label>
                    <select id="auditStatus" class="w-full bg-slate-800 border border-white/10 rounded p-2 text-sm text-slate-200">
                        <option value="Open">Open</option>
                        <option value="In-Progress">In-Progress</option>
                        <option value="Closed">Closed</option>
                    </select>
                </div>
                <div><label class="block text-xs font-bold text-slate-400 uppercase mb-2">PIC</label><input type="text" id="auditPicPri" class="w-full bg-slate-800 border border-white/10 rounded p-2 text-sm"></div>
                <div><label class="block text-xs font-bold text-slate-400 uppercase mb-2">Target Date</label><input type="date" id="auditTargetDate" class="w-full bg-slate-800 border border-white/10 rounded p-2 text-sm text-slate-200"></div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Progress: <span id="auditProgressVal" class="text-gold-400">0%</span></label>
                    <input type="range" id="auditProgress" min="0" max="100" class="w-full accent-gold-500">
                </div>
            </form>
        </div>
        <div class="bg-slate-950 p-4 border-t border-white/10 text-right rounded-b-xl">
            <button onclick="App.saveAudit()" class="bg-gold-500 hover:bg-gold-400 text-slate-900 font-bold py-2 px-6 rounded shadow-lg">Save Record</button>
        </div>
    </div>
</div>

<!-- SCRUM MODAL -->
<div id="scrumModal" class="fixed inset-0 z-[100] hidden items-center justify-center">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="App.closeModal('scrumModal')"></div>
    <div class="relative bg-slate-900 border border-white/10 rounded-xl shadow-2xl w-full max-w-md p-6">
        <h3 class="font-header text-xl text-white mb-4">Scrum Task</h3>
        <form id="scrumForm" class="space-y-4">
            <input type="hidden" id="scrumId">
            <div><label class="text-xs text-slate-400 uppercase">Task</label><input type="text" id="scrumText" class="w-full bg-slate-800 border border-white/10 rounded p-2 text-white"></div>
            <div><label class="text-xs text-slate-400 uppercase">User</label><input type="text" id="scrumUser" class="w-full bg-slate-800 border border-white/10 rounded p-2 text-white"></div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-xs text-slate-400 uppercase">Priority</label>
                    <select id="scrumPriority" class="w-full bg-slate-800 border border-white/10 rounded p-2 text-white">
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs text-slate-400 uppercase">Status</label>
                    <select id="scrumStatus" class="w-full bg-slate-800 border border-white/10 rounded p-2 text-white">
                        <option value="backlog">Backlog</option>
                        <option value="analysis">Doing</option>
                        <option value="verify">Verify</option>
                        <option value="done">Done</option>
                    </select>
                </div>
            </div>
        </form>
        <div class="mt-6 flex justify-between">
            <button id="btnDeleteScrum" onclick="App.deleteScrum()" class="text-red-400 text-sm hover:text-red-300">Delete</button>
            <button onclick="App.saveScrum()" class="bg-blue-600 hover:bg-blue-500 text-white py-2 px-4 rounded">Save Task</button>
        </div>
    </div>
</div>

<!-- TOASTS -->
<div id="toast-container" class="fixed bottom-5 right-5 z-[200] flex flex-col gap-2"></div>

<script>
const App = (() => {
    const STORE_KEY = 'QM_ENT_V4';
    let filterTerm = "";
    let chartInstance = null;
    
    // Default State
    let state = {
        audits: [
            { id: 1, desc: "Bag label misalignment on Line 2", imgBefore: "", plan: "Re-align sensor", imgAfter: "", status: "In-Progress", progress: 60, picPri: "John D.", targetDate: "2026-03-15", caTaken: "Adj sensor" }
        ],
        claims: [ { id: 101, text: "Report #001: Bag tear detected at Ship Loading." } ],
        scrumTasks: [
            { id: 1, text: 'Review SOP-001', user: 'Mike', priority: 'High', status: 'analysis' },
            { id: 2, text: 'Calibrate Scales', user: 'Team', priority: 'Medium', status: 'backlog' }
        ],
        sidebarCollapsed: false
    };

    // --- INITIALIZATION ---
    const init = () => {
        const saved = localStorage.getItem(STORE_KEY);
        if(saved) try { state = { ...state, ...JSON.parse(saved) }; } catch(e) { console.error("Load Error"); }
        
        // Restore Sidebar State (Desktop only)
        if(window.innerWidth > 1024 && state.sidebarCollapsed) {
            $('#sidebar').addClass('collapsed');
            $('#brandIconCollapsed').removeClass('opacity-0');
        }

        initChart();
        render();
        
        // Listeners
        $('#auditProgress').on('input', function() { $('#auditProgressVal').text(this.value + '%'); });
    };

    const saveState = () => {
        localStorage.setItem(STORE_KEY, JSON.stringify(state));
        render();
    };

    // --- UI LOGIC ---
    const toggleSidebar = () => {
        const sb = $('#sidebar');
        const overlay = $('#mobileBackdrop');
        const brandIcon = $('#brandIconCollapsed');

        if(window.innerWidth <= 1024) {
            // Mobile
            if(sb.hasClass('mobile-open')) {
                sb.removeClass('mobile-open');
                overlay.addClass('hidden');
            } else {
                sb.addClass('mobile-open');
                overlay.removeClass('hidden');
            }
        } else {
            // Desktop
            sb.toggleClass('collapsed');
            state.sidebarCollapsed = sb.hasClass('collapsed');
            
            if(state.sidebarCollapsed) {
                setTimeout(() => brandIcon.removeClass('opacity-0'), 150);
            } else {
                brandIcon.addClass('opacity-0');
            }
            
            localStorage.setItem(STORE_KEY, JSON.stringify(state));
            // Trigger resize for chart
            setTimeout(() => { if(chartInstance) chartInstance.resize(); }, 350);
        }
    };

    // --- CHART.JS ---
    const initChart = () => {
        const ctx = document.getElementById('qualityChart').getContext('2d');
        
        // Gradient
        let gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(234, 179, 8, 0.4)'); // Gold
        gradient.addColorStop(1, 'rgba(234, 179, 8, 0.0)');

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: 'Moisture Compliance %',
                    data: [92, 94, 89, 96, 95, 98],
                    borderColor: '#facc15',
                    backgroundColor: gradient,
                    borderWidth: 2,
                    pointBackgroundColor: '#fff',
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Defect Rate',
                    data: [5, 4, 8, 2, 3, 1],
                    borderColor: '#f87171', // Red
                    borderWidth: 2,
                    borderDash: [5, 5],
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { labels: { color: '#94a3b8' } },
                    tooltip: { backgroundColor: '#1e293b', titleColor: '#fff', bodyColor: '#ccc', borderColor: 'rgba(255,255,255,0.1)', borderWidth: 1 }
                },
                scales: {
                    y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#64748b' } },
                    x: { grid: { display: false }, ticks: { color: '#64748b' } }
                }
            }
        });
    };

    // --- RENDER ---
    const render = () => {
        const term = filterTerm.toLowerCase();

        // 1. Audit Table
        const filteredAudits = state.audits.filter(a => (a.desc || '').toLowerCase().includes(term));
        const tbody = document.getElementById('auditBody');
        
        if(filteredAudits.length === 0) {
            tbody.innerHTML = `<tr><td colspan="9" class="p-8 text-center text-slate-500">No records found.</td></tr>`;
        } else {
            tbody.innerHTML = filteredAudits.map((a, i) => {
                const imgB = a.imgBefore ? `<img src="${a.imgBefore}" class="w-8 h-8 rounded border border-white/20 object-cover cursor-pointer hover:scale-150 transition-transform">` : '<span class="text-xs text-slate-600">-</span>';
                const imgA = a.imgAfter ? `<img src="${a.imgAfter}" class="w-8 h-8 rounded border border-white/20 object-cover cursor-pointer hover:scale-150 transition-transform">` : '<span class="text-xs text-slate-600">-</span>';
                
                let statusColor = 'bg-blue-500/20 text-blue-400';
                if(a.status === 'Closed') statusColor = 'bg-green-500/20 text-green-400';
                if(a.status === 'Open') statusColor = 'bg-red-500/20 text-red-400';

                return `
                <tr class="transition-colors group">
                    <td class="p-3 text-center text-slate-500 text-xs">${i+1}</td>
                    <td class="p-3 text-center">${imgB}</td>
                    <td class="p-3 align-top">
                        <div class="font-bold text-slate-300 truncate max-w-[150px]" title="${a.desc}">${a.desc}</div>
                        <div class="text-xs text-gold-500/80 mt-1">${a.plan || 'No Plan'}</div>
                    </td>
                    <td class="p-3 text-center">${imgA}</td>
                    <td class="p-3 text-xs text-slate-400">${a.caTaken || '-'}</td>
                    <td class="p-3"><span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${statusColor}">${a.status}</span></td>
                    <td class="p-3 text-xs text-slate-300">${a.picPri}</td>
                    <td class="p-3 text-xs text-slate-500">${a.targetDate}</td>
                    <td class="p-3 text-center">
                        <button onclick="App.openAuditModal('edit', ${a.id})" class="text-blue-400 hover:text-white mx-1 transition-colors"><i class="fas fa-edit"></i></button>
                        <button onclick="App.deleteAudit(${a.id})" class="text-red-400 hover:text-white mx-1 transition-colors"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `}).join('');
        }

        // 2. Scrum Board
        const scrumCols = [
            { id: 'backlog', title: 'BACKLOG', color: 'border-slate-500' },
            { id: 'analysis', title: 'DOING', color: 'border-blue-500' },
            { id: 'verify', title: 'VERIFY', color: 'border-orange-500' },
            { id: 'done', title: 'DONE', color: 'border-green-500' }
        ];

        document.getElementById('scrumBoard').innerHTML = scrumCols.map(col => {
            const tasks = state.scrumTasks.filter(t => t.status === col.id);
            return `
            <div class="scrum-col bg-slate-800/50 rounded-lg p-3 border-t-2 ${col.color} min-w-[260px] flex flex-col h-full" 
                 ondragover="App.dragOver(event)" ondrop="App.drop(event, '${col.id}')">
                <div class="flex justify-between items-center mb-3 text-xs font-bold text-slate-400 tracking-wider">
                    <span>${col.title}</span>
                    <span class="bg-white/5 px-2 py-0.5 rounded text-slate-300">${tasks.length}</span>
                </div>
                <div class="space-y-2 flex-1 min-h-[50px]">
                    ${tasks.map(t => {
                        let priorityColor = t.priority === 'High' ? 'text-red-400 bg-red-500/10' : (t.priority === 'Medium' ? 'text-orange-400 bg-orange-500/10' : 'text-green-400 bg-green-500/10');
                        return `
                        <div class="scrum-card bg-slate-700/50 p-3 rounded border border-white/5 hover:border-gold-500/30 shadow-sm"
                             draggable="true" ondragstart="App.dragStart(event, ${t.id})" onclick="App.openScrumModal('edit', ${t.id})">
                            <div class="text-sm text-slate-200 mb-2">${t.text}</div>
                            <div class="flex justify-between items-center">
                                <span class="text-[10px] font-bold uppercase px-1.5 py-0.5 rounded ${priorityColor}">${t.priority}</span>
                                <div class="w-6 h-6 rounded-full bg-slate-800 border border-white/10 flex items-center justify-center text-[10px] text-slate-400">${t.user.substring(0,2).toUpperCase()}</div>
                            </div>
                        </div>
                    `}).join('')}
                </div>
            </div>`;
        }).join('');

        // 3. Update KPI Numbers
        document.getElementById('kpiClaims').innerText = state.claims.length;
        const doneTasks = state.scrumTasks.filter(t=>t.status==='done').length;
        const totalTasks = state.scrumTasks.length;
        document.getElementById('kpiScrum').innerText = totalTasks ? Math.round((doneTasks/totalTasks)*100)+'%' : '0%';

        // 4. Claims List
        document.getElementById('claimsList').innerHTML = state.claims.map(c => `
            <li class="bg-slate-800/50 p-3 rounded border-l-2 border-red-500 flex justify-between items-center text-sm group hover:bg-slate-800 transition-colors">
                <span class="text-slate-300">${c.text}</span>
                <button onclick="App.deleteClaim(${c.id})" class="text-slate-600 hover:text-red-400 transition-colors"><i class="fas fa-times"></i></button>
            </li>
        `).join('');
    };

    // --- ACTIONS ---
    const handleSearch = (val) => { filterTerm = val; render(); };
    
    // Audit Modal
    const openAuditModal = (mode, id) => {
        document.getElementById('auditForm').reset();
        $('#auditId').val(mode==='add'?'new':id);
        $('#auditProgressVal').text('0%');
        if(mode === 'edit') {
            const a = state.audits.find(x => x.id === id);
            if(a) {
                $('#auditDesc').val(a.desc); $('#auditImgBefore').val(a.imgBefore); $('#auditPlan').val(a.plan);
                $('#auditImgAfter').val(a.imgAfter); $('#auditCATaken').val(a.caTaken); $('#auditStatus').val(a.status);
                $('#auditPicPri').val(a.picPri); $('#auditTargetDate').val(a.targetDate); $('#auditProgress').val(a.progress);
                $('#auditProgressVal').text(a.progress+'%');
            }
        }
        $('#auditModal').removeClass('hidden').addClass('flex');
    };

    const saveAudit = () => {
        const id = $('#auditId').val();
        const data = {
            id: id==='new' ? Date.now() : parseInt(id),
            desc: $('#auditDesc').val(), imgBefore: $('#auditImgBefore').val(), plan: $('#auditPlan').val(),
            imgAfter: $('#auditImgAfter').val(), caTaken: $('#auditCATaken').val(), status: $('#auditStatus').val(),
            picPri: $('#auditPicPri').val(), targetDate: $('#auditTargetDate').val(), progress: $('#auditProgress').val()
        };
        if(id==='new') state.audits.push(data);
        else { const idx = state.audits.findIndex(x=>x.id===data.id); if(idx!==-1) state.audits[idx] = data; }
        saveState(); closeModal('auditModal'); showToast('Finding Saved', 'success');
    };

    const deleteAudit = (id) => { if(confirm("Delete finding?")) { state.audits = state.audits.filter(x=>x.id!==id); saveState(); showToast('Deleted', 'error'); } };

    // Scrum Modal
    const openScrumModal = (mode, id) => {
        $('#scrumForm')[0].reset();
        $('#scrumId').val(mode==='add'?'new':id);
        $('#btnDeleteScrum').toggle(mode==='edit');
        if(mode==='edit') {
            const t = state.scrumTasks.find(x=>x.id===id);
            if(t) { $('#scrumText').val(t.text); $('#scrumUser').val(t.user); $('#scrumPriority').val(t.priority); $('#scrumStatus').val(t.status); }
        }
        $('#scrumModal').removeClass('hidden').addClass('flex');
    };

    const saveScrum = () => {
        const id = $('#scrumId').val();
        const data = {
            id: id==='new'?Date.now():parseInt(id),
            text: $('#scrumText').val(), user: $('#scrumUser').val(), priority: $('#scrumPriority').val(), status: $('#scrumStatus').val()
        };
        if(id==='new') state.scrumTasks.push(data);
        else { const idx = state.scrumTasks.findIndex(x=>x.id===data.id); if(idx!==-1) state.scrumTasks[idx]=data; }
        saveState(); closeModal('scrumModal'); showToast('Task Saved', 'success');
    };

    const deleteScrum = () => { state.scrumTasks = state.scrumTasks.filter(x=>x.id!==parseInt($('#scrumId').val())); saveState(); closeModal('scrumModal'); };

    // Drag & Drop
    const dragStart = (e, id) => { e.dataTransfer.setData('text/plain', id); e.target.classList.add('dragging'); };
    const dragOver = (e) => { e.preventDefault(); $(e.currentTarget).addClass('drag-over'); };
    const drop = (e, status) => {
        e.preventDefault(); $('.scrum-col').removeClass('drag-over'); $('.scrum-card').removeClass('dragging');
        const id = parseInt(e.dataTransfer.getData('text/plain'));
        const t = state.scrumTasks.find(x=>x.id===id);
        if(t && t.status !== status) { t.status = status; saveState(); showToast(`Moved to ${status.toUpperCase()}`, 'success'); }
    };

    // Claims
    const addClaim = () => { const t = prompt("Claim Description:"); if(t){ state.claims.push({id:Date.now(), text:t}); saveState(); }};
    const deleteClaim = (id) => { if(confirm("Delete?")){ state.claims = state.claims.filter(x=>x.id!==id); saveState(); }};

    // Global Utils
    const closeModal = (id) => $(`#${id}`).addClass('hidden').removeClass('flex');
    const resetAll = () => { if(confirm("Reset ALL data?")) { localStorage.removeItem(STORE_KEY); location.reload(); }};
    
    // Export/Import
    const exportData = () => {
        const blob = new Blob([JSON.stringify(state)], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = "QM_Data_Backup.json";
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    };

    const importData = (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const r = new FileReader();
        r.onload = (e) => {
            try { state = JSON.parse(e.target.result); saveState(); location.reload(); } 
            catch(err) { alert("Invalid File"); }
        };
        r.readAsText(file);
    };

    const showToast = (msg, type) => {
        const color = type === 'success' ? 'border-green-500 text-green-400' : 'border-red-500 text-red-400';
        const icon = type === 'success' ? 'fa-check' : 'fa-info-circle';
        const t = $(`<div class="bg-slate-800 border-l-4 ${color} px-4 py-3 shadow-lg rounded flex items-center gap-3 transform translate-x-10 opacity-0 transition-all duration-300"><i class="fas ${icon}"></i><span class="text-sm font-bold text-slate-200">${msg}</span></div>`);
        $('#toast-container').append(t);
        setTimeout(() => t.removeClass('translate-x-10 opacity-0'), 50);
        setTimeout(() => t.addClass('translate-x-10 opacity-0').one('transitionend', () => t.remove()), 3000);
    };

    return { 
        init, toggleSidebar, handleSearch, 
        openAuditModal, saveAudit, deleteAudit, 
        openScrumModal, saveScrum, deleteScrum, dragStart, dragOver, drop,
        addClaim, deleteClaim, closeModal, resetAll, exportData, importData
    };
})();

document.addEventListener('DOMContentLoaded', App.init);
</script>

<script src="js/productqy.js" defer></script>
<script src="js/bubble.js" defer></script>


</body>
</html>
