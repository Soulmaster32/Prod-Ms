<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QM Dashboard 2026 - Material Pro</title>
    
    <!-- Fonts: Roboto (Standard Material) & Material Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- FontAwesome (Legacy Support) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Libraries -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <!-- Chart.js (Optional) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* --- MATERIAL THEME PALETTE --- */
            --md-primary: #3f51b5;       /* Indigo 500 */
            --md-primary-dark: #303f9f;  /* Indigo 700 */
            --md-primary-light: #c5cae9; /* Indigo 100 */
            --md-accent: #ffca28;        /* Amber 400 */
            --md-danger: #f44336;
            --md-success: #4caf50;
            --md-warning: #ff9800;
            
            /* Backgrounds */
            --bg-app: #f0f2f5;
            --bg-surface: #ffffff;
            --bg-sidebar: #263238;       /* Blue Grey 900 */
            
            /* Text */
            --text-primary: #212121;
            --text-secondary: #757575;
            --text-light: #ffffff;
            
            /* Elevation / Shadows */
            --shadow-1: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            --shadow-2: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
            --shadow-3: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
            
            --radius: 8px;
        }

        * { box-sizing: border-box; outline: none; }
        
        body {
            margin: 0; font-family: 'Roboto', sans-serif;
            background-color: var(--bg-app);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        /* --- LAYOUT STRUCTURE --- */
        .wrapper { display: flex; width: 100%; min-height: 100vh; }

        /* Sidebar */
        #sidebar {
            width: 260px; flex-shrink: 0;
            background: var(--bg-sidebar); color: var(--text-light);
            transition: margin 0.3s; display: flex; flex-direction: column;
            box-shadow: 2px 0 5px rgba(0,0,0,0.2); z-index: 100;
        }
        #sidebar.active { margin-left: -260px; }
        
        .sidebar-header {
            padding: 24px 20px; background: rgba(0,0,0,0.2);
            border-left: 4px solid var(--md-accent);
        }
        .sidebar-header h3 { margin: 0; font-weight: 300; letter-spacing: 1px; }
        .sidebar-header strong { font-weight: 700; color: var(--md-accent); }

        .menu-list { list-style: none; padding: 0; margin: 20px 0; }
        .menu-list li a {
            padding: 16px 24px; display: flex; align-items: center; color: #b0bec5;
            text-decoration: none; transition: 0.2s; font-size: 0.95rem; border-left: 4px solid transparent;
        }
        .menu-list li a:hover, .menu-list li.active a {
            background: rgba(255,255,255,0.05); color: white;
        }
        .menu-list li.active a { border-left-color: var(--md-accent); background: rgba(63, 81, 181, 0.2); }
        .menu-list li a i, .menu-list li a .material-icons { margin-right: 15px; width: 24px; text-align: center; }

        /* Main Content */
        #content { flex-grow: 1; padding: 24px; overflow-y: auto; height: 100vh; }
        
        /* Grid System */
        .dashboard-grid {
            display: grid; grid-template-columns: repeat(12, 1fr); gap: 24px;
            max-width: 1600px; margin: 0 auto;
        }
        .col-full { grid-column: 1 / -1; }
        .col-left { grid-column: 1 / 4; }
        .col-right { grid-column: 4 / -1; }
        .col-half { grid-column: span 6; }

        /* --- COMPONENT: CARDS (Surfaces) --- */
        .md-card {
            background: var(--bg-surface); border-radius: var(--radius);
            box-shadow: var(--shadow-1); padding: 24px;
            height: 100%; display: flex; flex-direction: column;
            transition: box-shadow 0.3s;
        }
        .md-card:hover { box-shadow: var(--shadow-2); }
        
        .section-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid #eee;
        }
        .section-title {
            font-size: 1.1rem; font-weight: 500; color: var(--md-primary);
            display: flex; align-items: center; gap: 10px;
        }
        
        /* --- COMPONENT: BUTTONS --- */
        .btn {
            border: none; border-radius: 4px; padding: 8px 16px;
            font-family: 'Roboto', sans-serif; font-weight: 500; text-transform: uppercase;
            font-size: 0.85rem; letter-spacing: 0.5px; cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s; display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-primary { background: var(--md-primary); color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .btn-primary:hover { background: var(--md-primary-dark); box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        
        .btn-accent { background: var(--md-accent); color: #333; }
        .btn-accent:hover { filter: brightness(95%); }
        
        .btn-text { background: transparent; color: var(--md-primary); }
        .btn-text:hover { background: rgba(63, 81, 181, 0.08); }
        
        .btn-icon { padding: 8px; border-radius: 50%; min-width: auto; }

        /* --- COMPONENT: INPUTS & SEARCH --- */
        .top-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--bg-surface); padding: 12px 24px; border-radius: var(--radius);
            box-shadow: var(--shadow-1); margin-bottom: 24px; flex-wrap: wrap; gap: 15px;
        }
        .search-wrapper { position: relative; flex: 1; max-width: 500px; }
        .search-wrapper input {
            width: 100%; padding: 10px 15px 10px 45px; border-radius: 4px;
            border: 1px solid #ddd; background: #f9f9f9; font-size: 1rem;
            transition: 0.3s;
        }
        .search-wrapper input:focus { background: white; border-color: var(--md-primary); box-shadow: 0 0 0 2px rgba(63,81,181,0.1); }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); }

        /* --- COMPONENT: DATA TABLE --- */
        .table-container { overflow-x: auto; border: 1px solid #eee; border-radius: 4px; }
        table.md-table { width: 100%; border-collapse: collapse; min-width: 1200px; font-size: 0.85rem; }
        table.md-table th {
            background: #fafafa; color: var(--text-secondary); font-weight: 500; text-transform: uppercase;
            padding: 12px 16px; text-align: left; border-bottom: 2px solid #eee; position: sticky; top: 0;
        }
        table.md-table td { padding: 12px 16px; border-bottom: 1px solid #eee; color: var(--text-primary); vertical-align: middle; }
        table.md-table tr:hover { background: #f5f5f5; }
        
        /* Images */
        .thumb-img { width: 48px; height: 48px; object-fit: cover; border-radius: 4px; cursor: pointer; transition: transform 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .thumb-img:hover { transform: scale(1.5); z-index: 10; }

        /* Status Chips */
        .chip { padding: 4px 10px; border-radius: 16px; font-size: 0.75rem; font-weight: 500; }
        .chip.green { background: #e8f5e9; color: #2e7d32; }
        .chip.orange { background: #fff3e0; color: #ef6c00; }
        .chip.red { background: #ffebee; color: #c62828; }
        .chip.blue { background: #e3f2fd; color: #1565c0; }

        /* --- SPECIFIC: KPI BOXES --- */
        .kpi-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .pq-box {
            background: #fff; border: 1px solid #eee; padding: 12px; border-radius: 6px;
            display: flex; flex-direction: column; align-items: center; text-align: center;
            transition: 0.2s; position: relative;
        }
        .pq-box:hover { border-color: var(--md-primary); transform: translateY(-2px); }
        .pq-label { font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        .pq-val { font-size: 1.5rem; font-weight: 300; color: var(--md-primary); margin-top: 4px; }

        /* --- SPECIFIC: SCRUM BOARD --- */
        .scrum-board { display: flex; gap: 16px; overflow-x: auto; padding-bottom: 10px; height: 450px; }
        .scrum-col {
            flex: 0 0 280px; background: #f5f5f5; border-radius: var(--radius);
            display: flex; flex-direction: column; padding: 12px;
            border-top: 4px solid var(--md-primary-light);
        }
        .scrum-header { display: flex; justify-content: space-between; margin-bottom: 12px; font-weight: 500; color: var(--text-secondary); }
        .scrum-list { flex: 1; overflow-y: auto; padding-right: 4px; }
        .task-card {
            background: white; padding: 12px; border-radius: 6px; margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 3px solid transparent;
            cursor: grab; transition: 0.2s;
        }
        .task-card:hover { box-shadow: 0 3px 6px rgba(0,0,0,0.15); transform: translateY(-2px); }
        .task-card.high { border-left-color: var(--md-danger); }
        .task-card.med { border-left-color: var(--md-warning); }
        .task-card.low { border-left-color: var(--md-success); }
        
        .task-meta { margin-top: 8px; display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: var(--text-secondary); }
        .user-avatar { width: 24px; height: 24px; border-radius: 50%; background: var(--md-primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; }

        /* --- SPECIFIC: SCHEDULE --- */
        .sched-grid {
            display: grid; grid-template-columns: 140px repeat(12, 1fr) 140px;
            font-size: 0.75rem; border: 1px solid #e0e0e0; border-radius: 4px; overflow: hidden;
        }
        .sch-head { background: #424242; color: white; padding: 8px; text-align: center; border-right: 1px solid #555; }
        .sch-cell { border-bottom: 1px solid #eee; border-right: 1px solid #eee; padding: 6px; display: flex; align-items: center; justify-content: center; text-align: center; }
        .bg-sched-blue { background: #42a5f5; color: white; }
        .bg-sched-green { background: #66bb6a; color: white; }
        .bg-sched-yellow { background: #ffee58; color: #333; }
        .bg-sched-red { background: #ef5350; color: white; }

        /* --- PROCESS FLOW --- */
        .flow-wrapper { display: flex; justify-content: center; flex-wrap: wrap; gap: 20px; padding: 20px 0; }
        .flow-step {
            width: 130px; background: white; border: 1px solid #e0e0e0; border-radius: 8px;
            padding: 16px 10px; text-align: center; position: relative; box-shadow: var(--shadow-1);
        }
        .flow-step:hover { border-color: var(--md-primary); box-shadow: var(--shadow-2); }
        .flow-num {
            width: 28px; height: 28px; background: var(--md-accent); color: #333;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: bold; margin: 0 auto 8px; font-size: 0.9rem;
        }
        .flow-arrow { display: flex; align-items: center; color: var(--text-secondary); }

        /* --- MODAL (Overlay) --- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000; display: none;
            align-items: center; justify-content: center; backdrop-filter: blur(2px);
        }
        .dialog {
            background: white; width: 100%; max-width: 800px; max-height: 90vh;
            border-radius: var(--radius); box-shadow: var(--shadow-3);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .dialog-header { padding: 16px 24px; background: var(--md-primary); color: white; display: flex; justify-content: space-between; align-items: center; }
        .dialog-body { padding: 24px; overflow-y: auto; }
        .dialog-footer { padding: 16px 24px; background: #f5f5f5; display: flex; justify-content: flex-end; gap: 10px; }
        
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .input-group { display: flex; flex-direction: column; gap: 6px; }
        .input-group label { font-size: 0.8rem; font-weight: 500; color: var(--md-primary); }
        .input-control { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: 'Roboto'; }
        .input-control:focus { border-color: var(--md-primary); box-shadow: 0 0 0 2px rgba(63,81,181,0.2); }

        /* Responsive */
        @media (max-width: 1024px) {
            .dashboard-grid { display: flex; flex-direction: column; }
            .col-left, .col-right, .col-half { width: 100%; }
            #sidebar { position: fixed; height: 100%; }
            #sidebar.active { margin-left: 0; }
            #sidebar { margin-left: -260px; } /* Hidden by default on mobile if logic reversed, but kept standard here */
        }
    </style>
</head>
<body>

<div class="wrapper">
    <!-- SIDEBAR -->
    <nav id="sidebar">
        <div class="sidebar-header">
            <h3>QUALITY <strong>PRO</strong></h3>
            <span style="font-size:0.75rem; opacity:0.7;">System V7.0</span>
        </div>
        
        <ul class="menu-list">
            <li class="active"><a href="#"><i class="material-icons">dashboard</i> Dashboard</a></li>
            <li><a href="#"><i class="material-icons">fact_check</i> Audits</a></li>
            <li><a href="#"><i class="material-icons">assignment</i> Claims</a></li>
            <li><a href="#"><i class="material-icons">folder_shared</i> Documents</a></li>
            <li><a href="#"><i class="material-icons">calendar_today</i> Schedule</a></li>
            <li><a href="#"><i class="material-icons">people</i> Team</a></li>
            <li><a href="#"><i class="material-icons">settings</i> Settings</a></li>
        </ul>
        
        <div style="margin-top:auto; padding: 20px; font-size: 0.75rem; text-align: center; color: #78909c;">
            &copy; 2026 Quality Dept
        </div>
    </nav>

    <!-- CONTENT -->
    <div id="content">
        <!-- TOP BAR -->
        <div class="top-bar">
            <div style="display:flex; align-items:center; gap:15px;">
                <button class="btn btn-icon btn-text" id="toggleSidebar">
                    <i class="material-icons">menu</i>
                </button>
                <h2 style="margin:0; font-weight:400; color:var(--md-primary-dark);">Dashboard Overview</h2>
            </div>
            
            <div class="search-wrapper">
                <i class="material-icons search-icon">search</i>
                <input type="text" id="searchInput" placeholder="Search findings, PIC, tags..." onkeyup="App.handleSearch(this.value)">
            </div>
            
            <div style="display:flex; gap:10px;">
                <button class="btn btn-text" onclick="App.exportData()"><i class="material-icons">download</i> Export</button>
                <button class="btn btn-text" onclick="$('#importFile').click()"><i class="material-icons">upload</i> Import</button>
                <input type="file" id="importFile" hidden onchange="App.importData(event)">
                <div style="width:36px; height:36px; background:var(--md-primary); color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold;">QA</div>
            </div>
        </div>

        <div class="dashboard-grid">
            
            <!-- LEFT COLUMN: KPIs & Vision -->
            <div class="col-left">
                <!-- Vision Card -->
                <div class="md-card" style="margin-bottom: 24px; background: linear-gradient(135deg, var(--md-primary) 0%, var(--md-primary-dark) 100%); color: white;">
                    <div style="margin-bottom:15px;">
                        <div style="font-size:0.8rem; opacity:0.8; text-transform:uppercase; letter-spacing:1px;">Vision Statement</div>
                        <div style="font-size:1rem; margin-top:5px; font-weight:300; line-height:1.4;">Achieving zero quality claims through excellent process standards and continuous monitoring.</div>
                    </div>
                    <div>
                        <div style="font-size:0.8rem; opacity:0.8; text-transform:uppercase; letter-spacing:1px;">Mission Statement</div>
                        <div style="font-size:0.9rem; margin-top:5px; font-weight:300; line-height:1.4;">Sustainable improvement via standardization, discipline, and equipment maintenance.</div>
                    </div>
                </div>

                <!-- Product Quality KPIs -->
                <div class="md-card">
                    <div class="section-header">
                        <span class="section-title"><i class="material-icons">analytics</i> Product Quality (YTD)</span>
                    </div>
                    <div class="kpi-grid">
                        <div class="pq-box"><span class="pq-label">Near Miss</span><span class="pq-val">6</span></div>
                        <div class="pq-box"><span class="pq-label">Int. Claims</span><span class="pq-val" style="color:var(--md-warning)">10</span></div>
                        <div class="pq-box"><span class="pq-label">Ext. Claims</span><span class="pq-val" style="color:var(--md-success)">0</span></div>
                        <div class="pq-box"><span class="pq-label">Batch Credit</span><span class="pq-val">98%</span></div>
                    </div>
                    
                    <div style="margin: 20px 0 10px; font-size:0.85rem; font-weight:bold; color:var(--text-secondary);">REPROCESS BAGS ANALYSIS</div>
                    <div class="kpi-grid">
                        <div class="pq-box"><span class="pq-label">Moisture</span><span class="pq-val" style="font-size:1.2rem">173</span></div>
                        <div class="pq-box"><span class="pq-label">High Cr</span><span class="pq-val" style="font-size:1.2rem">96</span></div>
                        <div class="pq-box"><span class="pq-label">High Mg</span><span class="pq-val" style="font-size:1.2rem">231</span></div>
                        <div class="pq-box"><span class="pq-label">Damaged</span><span class="pq-val" style="font-size:1.2rem">5</span></div>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN: Audits Table -->
            <div class="col-right">
                <div class="md-card" style="padding:0; overflow:hidden;">
                    <div style="padding:16px 24px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                        <span class="section-title"><i class="material-icons">table_view</i> Internal Audit Findings</span>
                        <button class="btn btn-primary" onclick="App.openModal('add')"><i class="material-icons" style="font-size:1rem;">add</i> Record Finding</button>
                    </div>
                    
                    <div class="table-container" style="border:none; height:600px; overflow-y:auto;">
                        <table class="md-table" id="auditTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Images</th>
                                    <th>Description & Plan</th>
                                    <th>Action Taken</th>
                                    <th>Work Req</th>
                                    <th>Status</th>
                                    <th>PIC</th>
                                    <th>Target</th>
                                    <th style="text-align:right;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="auditBody">
                                <!-- Dynamic Content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- FULL WIDTH: Schedule -->
            <div class="col-full">
                <div class="md-card">
                    <div class="section-header">
                        <span class="section-title"><i class="material-icons">event_note</i> Annual Schedule Matrix</span>
                    </div>
                    <div style="overflow-x:auto;">
                        <div class="sched-grid">
                            <!-- Header -->
                            <div class="sch-head">Activity / Month</div>
                            <div class="sch-head">Jan</div><div class="sch-head">Feb</div><div class="sch-head">Mar</div><div class="sch-head">Apr</div>
                            <div class="sch-head">May</div><div class="sch-head">Jun</div><div class="sch-head">Jul</div><div class="sch-head">Aug</div>
                            <div class="sch-head">Sep</div><div class="sch-head">Oct</div><div class="sch-head">Nov</div><div class="sch-head">Dec</div>
                            <div class="sch-head">Remarks</div>

                            <!-- Content Rows -->
                            <div class="sch-cell" style="font-weight:500; justify-content:flex-start; padding-left:10px;">Internal Audit</div>
                            <div class="sch-cell bg-sched-blue">Grp 1</div>
                            <div class="sch-cell"></div>
                            <div class="sch-cell" style="background:#eee;">Minor</div>
                            <div class="sch-cell bg-sched-green">Grp 4</div>
                            <div class="sch-cell"></div>
                            <div class="sch-cell bg-sched-red">Grp 2</div>
                            <div class="sch-cell"></div><div class="sch-cell"></div>
                            <div class="sch-cell" style="background:#eee;">Major</div>
                            <div class="sch-cell bg-sched-yellow">Grp 3</div>
                            <div class="sch-cell bg-sched-blue">Grp 1</div>
                            <div class="sch-cell">98% Done</div>

                            <div class="sch-cell" style="font-weight:500; justify-content:flex-start; padding-left:10px;">Cross Audit</div>
                            <div class="sch-cell"></div><div class="sch-cell bg-sched-yellow">Aud: JNY</div>
                            <div class="sch-cell"></div><div class="sch-cell"></div>
                            <div class="sch-cell bg-sched-blue">Aud: CLC</div>
                            <div class="sch-cell"></div><div class="sch-cell bg-sched-green">Aud: Team</div>
                            <div class="sch-cell bg-sched-red">Aud: Log</div>
                            <div class="sch-cell"></div><div class="sch-cell"></div><div class="sch-cell"></div><div class="sch-cell"></div>
                            <div class="sch-cell">>90% Comp</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ROW: Process & Claims -->
            <div class="col-half">
                <div class="md-card">
                    <div class="section-header">
                        <span class="section-title"><i class="material-icons">linear_scale</i> Process Flow: MS Bag Checking</span>
                    </div>
                    <div class="flow-wrapper">
                        <div class="flow-step">
                            <div class="flow-num">1</div>
                            <div style="font-size:0.8rem; font-weight:500;">Bagger Check</div>
                        </div>
                        <div class="flow-arrow"><i class="material-icons">arrow_forward</i></div>
                        <div class="flow-step">
                            <div class="flow-num">2</div>
                            <div style="font-size:0.8rem; font-weight:500;">CTS Quality</div>
                        </div>
                        <div class="flow-arrow"><i class="material-icons">arrow_forward</i></div>
                        <div class="flow-step">
                            <div class="flow-num">3</div>
                            <div style="font-size:0.8rem; font-weight:500;">Warehouse</div>
                        </div>
                    </div>
                    <div style="text-align:center; font-size:0.8rem; color:var(--text-secondary);">
                        <i class="material-icons" style="vertical-align:middle; font-size:1rem;">info</i> Click steps to edit SOP details (requires Extension).
                    </div>
                </div>
            </div>

            <div class="col-half">
                <div class="md-card">
                    <div class="section-header">
                        <span class="section-title"><i class="material-icons">report_problem</i> Claim Reports</span>
                        <button class="btn btn-text" onclick="App.addClaim()"><i class="material-icons">add</i> New</button>
                    </div>
                    <ul id="claimsList" style="list-style:none; padding:0; margin:0; flex:1; overflow-y:auto;">
                        <!-- Dynamic Claims -->
                    </ul>
                </div>
            </div>

            <!-- FULL: Scrum Board -->
            <div class="col-full">
                <div class="md-card">
                    <div class="section-header">
                        <span class="section-title"><i class="material-icons">view_kanban</i> Kaizen / Task Board</span>
                        <div>
                            <span id="taskProgress" style="font-size:0.85rem; color:var(--text-secondary); margin-right:15px;">0% Complete</span>
                            <button class="btn btn-accent" onclick="App.openScrumModal('add')"><i class="material-icons" style="font-size:1rem;">add</i> Add Task</button>
                        </div>
                    </div>
                    
                    <div class="scrum-board" id="scrumBoard">
                        <!-- Scrum Columns -->
                    </div>
                </div>
            </div>

        </div> <!-- End Grid -->
    </div>
</div>

<!-- AUDIT MODAL -->
<div class="overlay" id="auditModal">
    <div class="dialog">
        <div class="dialog-header">
            <h3 style="margin:0;">Audit Finding Record</h3>
            <button onclick="App.closeModal('auditModal')" style="background:none; border:none; color:white; cursor:pointer;"><i class="material-icons">close</i></button>
        </div>
        <div class="dialog-body">
            <form id="auditForm">
                <input type="hidden" id="auditId">
                <div class="input-group" style="margin-bottom:15px;">
                    <label>Finding Description</label>
                    <textarea id="auditDesc" rows="2" class="input-control" required></textarea>
                </div>
                
                <div class="form-row">
                    <div class="input-group"><label>Before Image URL</label><input type="text" id="auditImgBefore" class="input-control"></div>
                    <div class="input-group"><label>After Image URL</label><input type="text" id="auditImgAfter" class="input-control"></div>
                </div>

                <div class="form-row">
                    <div class="input-group"><label>Plan of Action</label><input type="text" id="auditPlan" class="input-control"></div>
                    <div class="input-group"><label>Work Request No.</label><input type="text" id="auditWorkReq" class="input-control"></div>
                </div>

                <div class="form-row">
                    <div class="input-group"><label>Primary PIC</label><input type="text" id="auditPicPri" class="input-control"></div>
                    <div class="input-group"><label>Secondary PIC</label><input type="text" id="auditPicSec" class="input-control"></div>
                </div>

                <div class="form-row">
                    <div class="input-group"><label>Status</label>
                        <select id="auditStatus" class="input-control">
                            <option value="Open">Open</option>
                            <option value="In-Progress">In-Progress</option>
                            <option value="Closed">Closed</option>
                            <option value="Delayed">Delayed</option>
                        </select>
                    </div>
                    <div class="input-group"><label>Progress (%)</label>
                        <input type="number" id="auditProgress" class="input-control" min="0" max="100">
                    </div>
                </div>
                 <div class="form-row">
                    <div class="input-group"><label>Target Date</label><input type="date" id="auditTargetDate" class="input-control"></div>
                </div>
            </form>
        </div>
        <div class="dialog-footer">
            <button class="btn btn-text" onclick="App.closeModal('auditModal')">Cancel</button>
            <button class="btn btn-primary" onclick="App.saveAudit()">Save Record</button>
        </div>
    </div>
</div>

<!-- SCRUM MODAL -->
<div class="overlay" id="scrumModal">
    <div class="dialog" style="max-width:500px;">
        <div class="dialog-header">
            <h3 style="margin:0;">Task Details</h3>
            <button onclick="App.closeModal('scrumModal')" style="background:none; border:none; color:white; cursor:pointer;"><i class="material-icons">close</i></button>
        </div>
        <div class="dialog-body">
            <form id="scrumForm">
                <input type="hidden" id="scrumId">
                <div class="input-group" style="margin-bottom:15px;">
                    <label>Task Description</label>
                    <input type="text" id="scrumText" class="input-control" required>
                </div>
                <div class="form-row">
                    <div class="input-group"><label>Assignee</label><input type="text" id="scrumUser" class="input-control"></div>
                    <div class="input-group"><label>Priority</label>
                        <select id="scrumPriority" class="input-control">
                            <option value="High">High</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>
                </div>
                <div class="input-group"><label>Status Column</label>
                    <select id="scrumStatus" class="input-control">
                        <option value="backlog">Backlog</option>
                        <option value="analysis">Doing</option>
                        <option value="verify">Verify</option>
                        <option value="done">Done</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="dialog-footer">
            <button class="btn btn-text" style="color:var(--md-danger); margin-right:auto;" onclick="App.deleteScrum()">Delete</button>
            <button class="btn btn-primary" onclick="App.saveScrum()">Save Task</button>
        </div>
    </div>
</div>

<!-- CORE APP LOGIC -->
<script>
    // --- UI INTERACTIONS ---
    $('#toggleSidebar').click(function() { $('#sidebar').toggleClass('active'); });
    $('.overlay').click(function(e) { if($(e.target).is('.overlay')) $(this).fadeOut(200); });

    const App = (() => {
        const STORE_KEY = 'QM_PRO_SYSTEM_V7';
        let filterTerm = "";
        
        let state = {
            audits: [
                {
                    id: 1, desc: "Sensor misalignment on Line 2", imgBefore: "https://via.placeholder.com/150", 
                    plan: "Re-align sensor", workReq: "WR-001", status: "In-Progress", progress: 50,
                    picPri: "John Doe", targetDate: "2026-03-15"
                }
            ],
            claims: [{id: 101, text: "Bag tear at Ship Loading (Stage 9). 5 bags affected."}],
            scrumTasks: [
                {id: 1, text: "Update ISO Guidelines", user: "Jane", priority: "High", status: "analysis"},
                {id: 2, text: "Check Equipment Calibration", user: "Mike", priority: "Medium", status: "backlog"}
            ]
        };

        const scrumCols = [
            { id: 'backlog', title: 'BACKLOG' },
            { id: 'analysis', title: 'DOING' },
            { id: 'verify', title: 'VERIFY' },
            { id: 'done', title: 'DONE' }
        ];

        const init = () => {
            const loaded = localStorage.getItem(STORE_KEY);
            if(loaded) { try { state = JSON.parse(loaded); } catch(e){ console.error(e); } }
            render();
        };

        const save = () => { localStorage.setItem(STORE_KEY, JSON.stringify(state)); render(); };

        const render = () => {
            // RENDER AUDITS
            const tbody = document.getElementById('auditBody');
            const filtered = state.audits.filter(a => 
                (a.desc && a.desc.toLowerCase().includes(filterTerm)) ||
                (a.picPri && a.picPri.toLowerCase().includes(filterTerm))
            );
            
            tbody.innerHTML = filtered.length ? filtered.map((a, i) => {
                let statusColor = a.status === 'Closed' ? 'green' : (a.status === 'Delayed' ? 'red' : 'blue');
                return `
                <tr>
                    <td>${i+1}</td>
                    <td>${a.imgBefore ? `<img src="${a.imgBefore}" class="thumb-img" onclick="window.open(this.src)">` : '-'}</td>
                    <td>
                        <div style="font-weight:500;">${a.desc}</div>
                        <div style="font-size:0.75rem; color:#888;">Plan: ${a.plan || 'Pending'}</div>
                    </td>
                    <td>${a.caTaken || '-'}</td>
                    <td><span style="font-family:monospace; background:#eee; padding:2px 4px; border-radius:3px;">${a.workReq || 'N/A'}</span></td>
                    <td>
                        <span class="chip ${statusColor}">${a.status}</span>
                        <div style="width:60px; height:4px; background:#eee; margin-top:5px; border-radius:2px;">
                            <div style="width:${a.progress}%; background:var(--md-primary); height:100%;"></div>
                        </div>
                    </td>
                    <td>${a.picPri}</td>
                    <td>${a.targetDate}</td>
                    <td style="text-align:right;">
                        <button class="btn btn-icon btn-text" onclick="App.openModal('edit', ${a.id})"><i class="material-icons">edit</i></button>
                        <button class="btn btn-icon btn-text" style="color:var(--md-danger);" onclick="App.deleteAudit(${a.id})"><i class="material-icons">delete</i></button>
                    </td>
                </tr>
            `}).join('') : `<tr><td colspan="9" style="text-align:center; padding:20px; color:#999;">No records found.</td></tr>`;

            // RENDER CLAIMS
            document.getElementById('claimsList').innerHTML = state.claims.map(c => `
                <li style="padding:12px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-size:0.9rem; color:var(--md-danger);"><i class="material-icons" style="font-size:1rem; vertical-align:text-bottom;">warning</i> ${c.text}</div>
                    <button class="btn btn-icon btn-text" onclick="App.deleteClaim(${c.id})"><i class="material-icons">close</i></button>
                </li>
            `).join('');

            // RENDER SCRUM
            const board = document.getElementById('scrumBoard');
            const total = state.scrumTasks.length;
            const done = state.scrumTasks.filter(t => t.status === 'done').length;
            document.getElementById('taskProgress').innerText = total ? `${Math.round((done/total)*100)}% Complete` : 'No Tasks';

            board.innerHTML = scrumCols.map(col => {
                const tasks = state.scrumTasks.filter(t => t.status === col.id);
                return `
                <div class="scrum-col" ondragover="App.dragOver(event)" ondrop="App.drop(event, '${col.id}')">
                    <div class="scrum-header"><span>${col.title}</span> <span>${tasks.length}</span></div>
                    <div class="scrum-list">
                        ${tasks.map(t => {
                            let priorityClass = t.priority === 'High' ? 'high' : (t.priority === 'Medium' ? 'med' : 'low');
                            return `
                            <div class="task-card ${priorityClass}" draggable="true" ondragstart="App.dragStart(event, ${t.id})" onclick="App.openScrumModal('edit', ${t.id})">
                                <div style="font-weight:500; font-size:0.9rem;">${t.text}</div>
                                <div class="task-meta">
                                    <div class="user-avatar">${t.user ? t.user.substring(0,2).toUpperCase() : '?'}</div>
                                    <span>${t.priority}</span>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                </div>
            `}).join('');
        };

        // --- ACTIONS ---
        const handleSearch = (val) => { filterTerm = val.toLowerCase(); render(); };
        
        // Audit CRUD
        const openModal = (mode, id) => {
            document.getElementById('auditForm').reset();
            document.getElementById('auditId').value = mode === 'add' ? 'new' : id;
            if(mode === 'edit') {
                const a = state.audits.find(x => x.id === id);
                if(a) {
                    $('#auditDesc').val(a.desc); $('#auditImgBefore').val(a.imgBefore);
                    $('#auditPlan').val(a.plan); $('#auditWorkReq').val(a.workReq);
                    $('#auditStatus').val(a.status); $('#auditProgress').val(a.progress);
                    $('#auditPicPri').val(a.picPri); $('#auditTargetDate').val(a.targetDate);
                }
            }
            $('#auditModal').css('display','flex').hide().fadeIn(200);
        };

        const saveAudit = () => {
            const id = $('#auditId').val();
            const data = {
                id: id === 'new' ? Date.now() : parseInt(id),
                desc: $('#auditDesc').val(), imgBefore: $('#auditImgBefore').val(),
                plan: $('#auditPlan').val(), workReq: $('#auditWorkReq').val(),
                status: $('#auditStatus').val(), progress: $('#auditProgress').val(),
                picPri: $('#auditPicPri').val(), targetDate: $('#auditTargetDate').val()
            };
            if(id === 'new') state.audits.push(data);
            else { const idx = state.audits.findIndex(x => x.id == id); if(idx > -1) state.audits[idx] = data; }
            save(); closeModal('auditModal');
        };

        const deleteAudit = (id) => { if(confirm("Delete record?")) { state.audits = state.audits.filter(x => x.id !== id); save(); } };

        // Scrum CRUD
        const openScrumModal = (mode, id) => {
            $('#scrumForm')[0].reset();
            $('#scrumId').val(mode === 'add' ? 'new' : id);
            if(mode === 'edit') {
                const t = state.scrumTasks.find(x => x.id === id);
                if(t) {
                    $('#scrumText').val(t.text); $('#scrumUser').val(t.user);
                    $('#scrumPriority').val(t.priority); $('#scrumStatus').val(t.status);
                }
            }
            $('#scrumModal').css('display','flex').hide().fadeIn(200);
        };
        
        const saveScrum = () => {
            const id = $('#scrumId').val();
            const data = {
                id: id === 'new' ? Date.now() : parseInt(id),
                text: $('#scrumText').val(), user: $('#scrumUser').val(),
                priority: $('#scrumPriority').val(), status: $('#scrumStatus').val()
            };
            if(id === 'new') state.scrumTasks.push(data);
            else { const idx = state.scrumTasks.findIndex(x => x.id == id); if(idx > -1) state.scrumTasks[idx] = data; }
            save(); closeModal('scrumModal');
        };

        const deleteScrum = () => {
            const id = parseInt($('#scrumId').val());
            if(id && confirm("Delete task?")) { state.scrumTasks = state.scrumTasks.filter(x => x.id !== id); save(); closeModal('scrumModal'); }
        }

        // Claims
        const addClaim = () => { const t = prompt("Report Description:"); if(t) { state.claims.push({id:Date.now(), text:t}); save(); } };
        const deleteClaim = (id) => { if(confirm("Resolve/Remove report?")) { state.claims = state.claims.filter(x => x.id !== id); save(); } };

        // Drag & Drop
        const dragStart = (e, id) => e.dataTransfer.setData("text", id);
        const dragOver = (e) => e.preventDefault();
        const drop = (e, status) => {
            e.preventDefault();
            const id = parseInt(e.dataTransfer.getData("text"));
            const task = state.scrumTasks.find(t => t.id === id);
            if(task) { task.status = status; save(); }
        };

        // Helpers
        const closeModal = (id) => $(`#${id}`).fadeOut(200);
        const exportData = () => {
            const data = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
            const a = document.createElement('a'); a.href = data; a.download = "QM_Backup.json"; a.click();
        };
        const importData = (e) => {
            const fr = new FileReader();
            fr.onload = (ev) => { try { state = JSON.parse(ev.target.result); save(); location.reload(); } catch(err){alert("Invalid File");} };
            if(e.target.files[0]) fr.readAsText(e.target.files[0]);
        };

        return { init, handleSearch, openModal, saveAudit, deleteAudit, openScrumModal, saveScrum, deleteScrum, addClaim, deleteClaim, dragStart, dragOver, drop, closeModal, exportData, importData };
    })();

    $(document).ready(App.init);
</script>

<!-- Load Extension if available -->
<script src="extension.js"></script>

</body>
</html>
